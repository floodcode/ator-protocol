name: Build Debian Packages

on:
  pull_request:
    branches:
      - main

env:
  BUILDUSER: build
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-source:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup
        run: |
          rm -rf build-env
          apt-get -y update
          apt-get -y dist-upgrade
          apt-get -y install sudo build-essential
          apt-get -y install $(cat debian/.debian-ci/build_source/build-depends)
          adduser --system --group --disabled-password --shell /bin/sh --home /build-env "${BUILDUSER}"
          git config --global --add safe.directory $(realpath .)
      - name: Build from Source
        run: |
          ls -la
          sudo -i -u "${BUILDUSER}" --preserve-env=GITHUB_REF $(pwd)/debian/.debian-ci/build_source/build-script
          mv -v --no-target-directory build-env/RESULT source-packages
